#!/usr/bin/env ruby

require "bundler/setup"
require "detector"

if ARGV.empty?
  puts "Detector v#{Detector::VERSION}"
  puts "Usage: detector <URI>"
  puts "Example: detector \"postgres://user:pass@host:port/dbname\""
  exit 1
end

uri = ARGV[0]
detector = Detector.detect(uri)

if detector.nil?
  puts "Invalid or unsupported URI: #{uri}"
  exit 1
end

puts "Detector v#{Detector::VERSION}"
puts "Detected: #{detector.kind}"
puts "Version: #{detector.version}"
puts "Host: #{detector.host}:#{detector.port}"

if detector.connection_count && detector.connection_limit
  usage = detector.connection_usage_percentage
  puts "Connections: #{detector.connection_count}/#{detector.connection_limit} (#{usage}%)"
end

if detector.respond_to?(:replication_available?) && !detector.replication_available?.nil?
  puts "Replication: #{detector.replication_available? ? 'Available' : 'Not available'}"
end

if detector.user_access_level
  puts "User access level: #{detector.user_access_level}"
end

if detector.infrastructure
  puts "Infrastructure: #{detector.infrastructure}"
end

if detector.geography
  puts "Location: #{detector.geography}"
end

if detector.region
  puts "Region: #{detector.region}"
end

if detector.asn
  puts "ASN: #{detector.asn}"
end

if detector.databases?
  db_count = detector.database_count
  puts "\nDatabases: #{db_count}"
  
  if db_count && db_count > 0
    dbs = detector.databases.first(3)
    dbs.each do |db|
      db_name = db[:name]
      puts "\nDatabase: #{db_name} (#{db[:size]})"
      
      if detector.tables?
        if db[:table_count]
          puts "  Tables: #{db[:table_count]}"
        else
          puts "  Tables: #{detector.table_count(db_name)}"
        end
        
        tables = detector.tables(db_name).first(3) 
        tables.each do |table|
          puts "    - #{table[:name]}: #{table[:row_count]} rows (#{table[:size]})"
        end
      end
    end
  end
end 